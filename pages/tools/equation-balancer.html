<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Balance chemical equations automatically">
    <title>Equation Balancer - SBS Tools</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../assets/css/main.css">
    <link rel="stylesheet" href="../../assets/css/mobile.css">
    <link rel="stylesheet" href="../../assets/css/tool-page.css">
</head>
<body>
    <div id="navbar-container"></div>
    <script src="../../assets/js/navbar.js"></script>

    <main class="tool-page">
        <div class="tool-container">
            <div class="tool-header">
                <h1><i data-lucide="equal"></i> Chemical Equation Balancer</h1>
                <p>Automatically balance chemical equations</p>
            </div>

            <div class="tool-card">
                <div class="form-group">
                    <label>Enter Chemical Equation</label>
                    <input type="text" id="equation-input" placeholder="e.g., H2 + O2 = H2O">
                    <small class="input-hint">Use + to separate compounds and = or -> for the reaction arrow</small>
                </div>
                <button class="tool-btn tool-btn-primary" onclick="balanceEquation()">
                    <i data-lucide="scale"></i> Balance Equation
                </button>

                <div class="examples">
                    <span>Examples:</span>
                    <button onclick="setEquation('H2 + O2 = H2O')">H₂ + O₂ → H₂O</button>
                    <button onclick="setEquation('Fe + O2 = Fe2O3')">Fe + O₂ → Fe₂O₃</button>
                    <button onclick="setEquation('C3H8 + O2 = CO2 + H2O')">C₃H₈ + O₂ → CO₂ + H₂O</button>
                    <button onclick="setEquation('NaOH + H2SO4 = Na2SO4 + H2O')">NaOH + H₂SO₄ → Na₂SO₄ + H₂O</button>
                    <button onclick="setEquation('KMnO4 + HCl = KCl + MnCl2 + H2O + Cl2')">KMnO₄ + HCl → ...</button>
                    <button onclick="setEquation('Ca(OH)2 + H3PO4 = Ca3(PO4)2 + H2O')">Ca(OH)₂ + H₃PO₄ → ...</button>
                </div>
            </div>

            <div class="tool-card" id="result-card" style="display: none;">
                <h3><i data-lucide="check-circle"></i> Balanced Equation</h3>
                <div class="balanced-equation" id="balanced-equation"></div>
                
                <div class="verification">
                    <h4><i data-lucide="list-checks"></i> Element Verification</h4>
                    <div class="verification-table" id="verification-table"></div>
                </div>
            </div>

            <div class="tool-card">
                <h3><i data-lucide="info"></i> How to Use</h3>
                <div class="guide-content">
                    <p><strong>Format:</strong> Write reactants on the left, products on the right</p>
                    <p><strong>Arrow:</strong> Use <code>=</code> or <code>-></code> to separate sides</p>
                    <p><strong>Plus sign:</strong> Use <code>+</code> to separate compounds</p>
                    <p><strong>Parentheses:</strong> Supported, e.g., Ca(OH)2, Fe2(SO4)3</p>
                    <p><strong>Tip:</strong> Don't include coefficients in your input - they will be calculated!</p>
                </div>
            </div>
        </div>
    </main>

    <style>
        .input-hint {
            display: block;
            margin-top: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        .examples {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        .examples span {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .examples button {
            padding: 0.4rem 0.8rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }
        .examples button:hover {
            background: var(--accent-color);
            border-color: var(--accent-color);
            color: white;
        }
        .balanced-equation {
            font-size: 1.5rem;
            text-align: center;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(139, 92, 246, 0.1));
            border-radius: 12px;
            margin: 1.5rem 0;
            font-family: 'Courier New', monospace;
        }
        .balanced-equation .coefficient {
            color: var(--accent-color);
            font-weight: 700;
        }
        .balanced-equation .arrow {
            margin: 0 1rem;
            color: var(--text-secondary);
        }
        .balanced-equation .plus {
            margin: 0 0.5rem;
            color: var(--text-secondary);
        }
        .verification {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        .verification h4 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }
        .verification-table {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.75rem;
        }
        .verify-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
        }
        .verify-item.balanced {
            border-left: 3px solid #38d9a9;
        }
        .verify-element { font-weight: 600; font-family: 'Courier New', monospace; }
        .verify-count { color: var(--text-secondary); font-size: 0.9rem; }
        .guide-content {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            color: var(--text-secondary);
        }
        .guide-content p { margin: 0; }
        .guide-content strong { color: var(--text-primary); }
        .guide-content code {
            background: var(--bg-secondary);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        @media (max-width: 600px) {
            .balanced-equation { font-size: 1.1rem; padding: 1rem; }
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            document.getElementById('equation-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') balanceEquation();
            });
        });

        function setEquation(eq) {
            document.getElementById('equation-input').value = eq;
            balanceEquation();
        }

        function balanceEquation() {
            const input = document.getElementById('equation-input').value.trim();
            if (!input) return;

            try {
                // Parse equation
                const [leftSide, rightSide] = input.split(/\s*(?:=|->|→)\s*/);
                if (!leftSide || !rightSide) throw new Error('Invalid equation format');

                const reactants = leftSide.split(/\s*\+\s*/).map(s => s.trim()).filter(s => s);
                const products = rightSide.split(/\s*\+\s*/).map(s => s.trim()).filter(s => s);

                const allCompounds = [...reactants, ...products];
                const numCompounds = allCompounds.length;
                const numReactants = reactants.length;

                // Get all elements in equation
                const elements = new Set();
                allCompounds.forEach(compound => {
                    const composition = parseCompound(compound);
                    Object.keys(composition).forEach(el => elements.add(el));
                });
                const elementList = Array.from(elements);

                // Build matrix for linear system
                const matrix = [];
                elementList.forEach(element => {
                    const row = [];
                    allCompounds.forEach((compound, idx) => {
                        const composition = parseCompound(compound);
                        const count = composition[element] || 0;
                        // Products are negative (right side of equation)
                        row.push(idx >= numReactants ? -count : count);
                    });
                    matrix.push(row);
                });

                // Solve using null space approach (find integer solutions)
                const coefficients = solveMatrix(matrix, numCompounds);
                
                if (!coefficients) {
                    throw new Error('Could not balance equation');
                }

                // Display results
                displayResult(reactants, products, coefficients, elementList);

            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function parseCompound(compound) {
            const composition = {};
            parseGroup(compound, 1, composition);
            return composition;
        }

        function parseGroup(group, multiplier, composition) {
            let i = 0;
            while (i < group.length) {
                if (group[i] === '(' || group[i] === '[') {
                    let depth = 1;
                    let j = i + 1;
                    while (j < group.length && depth > 0) {
                        if (group[j] === '(' || group[j] === '[') depth++;
                        if (group[j] === ')' || group[j] === ']') depth--;
                        j++;
                    }
                    const innerGroup = group.slice(i + 1, j - 1);
                    let subscript = '';
                    while (j < group.length && /\d/.test(group[j])) {
                        subscript += group[j];
                        j++;
                    }
                    subscript = subscript ? parseInt(subscript) : 1;
                    parseGroup(innerGroup, multiplier * subscript, composition);
                    i = j;
                } else if (/[A-Z]/.test(group[i])) {
                    let element = group[i];
                    let j = i + 1;
                    while (j < group.length && /[a-z]/.test(group[j])) {
                        element += group[j];
                        j++;
                    }
                    let subscript = '';
                    while (j < group.length && /\d/.test(group[j])) {
                        subscript += group[j];
                        j++;
                    }
                    subscript = subscript ? parseInt(subscript) : 1;
                    composition[element] = (composition[element] || 0) + subscript * multiplier;
                    i = j;
                } else {
                    i++;
                }
            }
        }

        function solveMatrix(matrix, numVars) {
            // Try small integer coefficients using brute force for small equations
            const maxCoef = 20;
            
            function checkSolution(coeffs) {
                for (const row of matrix) {
                    let sum = 0;
                    for (let i = 0; i < coeffs.length; i++) {
                        sum += row[i] * coeffs[i];
                    }
                    if (sum !== 0) return false;
                }
                return true;
            }

            function* generateCombinations(n, max, current = []) {
                if (current.length === n) {
                    yield [...current];
                    return;
                }
                for (let i = 1; i <= max; i++) {
                    current.push(i);
                    yield* generateCombinations(n, max, current);
                    current.pop();
                }
            }

            // For small number of compounds, try brute force
            if (numVars <= 6) {
                for (const coeffs of generateCombinations(numVars, maxCoef)) {
                    if (checkSolution(coeffs)) {
                        // Find GCD to simplify
                        let g = coeffs[0];
                        for (let i = 1; i < coeffs.length; i++) {
                            g = gcd(g, coeffs[i]);
                        }
                        return coeffs.map(c => c / g);
                    }
                }
            }

            // Fallback: Use Gaussian elimination approach
            return gaussianSolve(matrix, numVars);
        }

        function gaussianSolve(matrix, numVars) {
            // Convert to augmented matrix and solve
            const m = matrix.map(row => [...row, 0]);
            const rows = m.length;
            const cols = m[0].length;
            
            // Forward elimination
            let pivot = 0;
            for (let col = 0; col < cols - 1 && pivot < rows; col++) {
                // Find non-zero pivot
                let maxRow = pivot;
                for (let row = pivot + 1; row < rows; row++) {
                    if (Math.abs(m[row][col]) > Math.abs(m[maxRow][col])) {
                        maxRow = row;
                    }
                }
                
                if (Math.abs(m[maxRow][col]) < 1e-10) continue;
                
                [m[pivot], m[maxRow]] = [m[maxRow], m[pivot]];
                
                for (let row = 0; row < rows; row++) {
                    if (row !== pivot && Math.abs(m[row][col]) > 1e-10) {
                        const factor = m[row][col] / m[pivot][col];
                        for (let c = col; c < cols; c++) {
                            m[row][c] -= factor * m[pivot][c];
                        }
                    }
                }
                pivot++;
            }

            // Find free variables and create solution
            const solution = new Array(numVars).fill(1);
            
            // Scale to integers
            for (let i = 0; i < 1000; i++) {
                solution[numVars - 1] = i + 1;
                const test = [...solution];
                
                // Back substitute
                for (let row = Math.min(pivot - 1, rows - 1); row >= 0; row--) {
                    let pivotCol = -1;
                    for (let col = 0; col < numVars; col++) {
                        if (Math.abs(m[row][col]) > 1e-10) {
                            pivotCol = col;
                            break;
                        }
                    }
                    if (pivotCol === -1) continue;
                    
                    let sum = 0;
                    for (let col = pivotCol + 1; col < numVars; col++) {
                        sum += m[row][col] * test[col];
                    }
                    test[pivotCol] = -sum / m[row][pivotCol];
                }
                
                // Check if all positive integers
                const rounded = test.map(x => Math.round(x * 1000) / 1000);
                if (rounded.every(x => x > 0 && Math.abs(x - Math.round(x)) < 0.01)) {
                    const intSolution = rounded.map(x => Math.round(x));
                    let g = intSolution[0];
                    for (let j = 1; j < intSolution.length; j++) {
                        g = gcd(g, intSolution[j]);
                    }
                    return intSolution.map(x => x / g);
                }
            }
            
            return null;
        }

        function gcd(a, b) {
            a = Math.abs(Math.round(a));
            b = Math.abs(Math.round(b));
            while (b) {
                [a, b] = [b, a % b];
            }
            return a;
        }

        function displayResult(reactants, products, coefficients, elements) {
            const numReactants = reactants.length;
            
            // Build balanced equation HTML
            let html = '';
            
            // Reactants
            reactants.forEach((compound, idx) => {
                if (idx > 0) html += '<span class="plus">+</span>';
                const coef = coefficients[idx];
                if (coef > 1) {
                    html += `<span class="coefficient">${coef}</span>`;
                }
                html += formatCompound(compound);
            });
            
            html += '<span class="arrow">→</span>';
            
            // Products
            products.forEach((compound, idx) => {
                if (idx > 0) html += '<span class="plus">+</span>';
                const coef = coefficients[numReactants + idx];
                if (coef > 1) {
                    html += `<span class="coefficient">${coef}</span>`;
                }
                html += formatCompound(compound);
            });
            
            document.getElementById('balanced-equation').innerHTML = html;
            
            // Verification table
            let verifyHTML = '';
            elements.forEach(element => {
                let leftCount = 0;
                let rightCount = 0;
                
                reactants.forEach((compound, idx) => {
                    const composition = parseCompound(compound);
                    leftCount += (composition[element] || 0) * coefficients[idx];
                });
                
                products.forEach((compound, idx) => {
                    const composition = parseCompound(compound);
                    rightCount += (composition[element] || 0) * coefficients[numReactants + idx];
                });
                
                verifyHTML += `
                    <div class="verify-item balanced">
                        <span class="verify-element">${element}</span>
                        <span class="verify-count">${leftCount} = ${rightCount}</span>
                    </div>
                `;
            });
            
            document.getElementById('verification-table').innerHTML = verifyHTML;
            document.getElementById('result-card').style.display = 'block';
            lucide.createIcons();
        }

        function formatCompound(compound) {
            return compound.replace(/(\d+)/g, '<sub>$1</sub>');
        }
    </script>
</body>
</html>
